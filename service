#!/usr/bin/python
from hosted import device, node, config
import time

# Restart service when config changes in dashboard
config.restart_on_update()

# Map button names to dashboard-configurable pins
BUTTONS = {
    'power': config.gpio_power,
    'up': config.gpio_up,
    'down': config.gpio_down,
    'menu': config.gpio_menu,
    'select': config.gpio_select
}

# Monitor pins with pull-up resistors
for name, pin in BUTTONS.items():
    print("Monitoring button '%s' on GPIO %d" % (name, pin))
    device.gpio.monitor(pin, pull_up=True)

# Track state and debounce
last_state = {pin: True for pin in BUTTONS.values()}  # Assume high at rest
last_event_time = {pin: 0 for pin in BUTTONS.values()}
debounce_delay = 0.2  # 200ms debounce

print("Service started - monitoring GPIO pins")

# Poll GPIO for changes
for pin, state in device.gpio.poll_forever():
    name = next((n for n, p in BUTTONS.items() if p == pin), None)
    now = time.time()
    if name and not state and last_state[pin] and now - last_event_time[pin] > debounce_delay:
        # Falling edge detected (button press)
        print("Press detected on '%s' (GPIO %d)" % (name, pin))
        node.send("%s:0" % name)  # e.g., "up:0" sent to Lua
        last_event_time[pin] = now
    last_state[pin] = state
